<!DOCTYPE html>
<html lang="ru">

<head>
    <title>Распределённые транзакции &#x2F; Хабр</title>
    <meta property="fb:app_id" content="444736788986613">
    <meta property="fb:pages" content="472597926099084">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@habr_com">
    <meta property="og:site_name" content="Хабр">
    <link href="https://habr.com/ru/rss/post/769102/?fl=ru" type="application/rss+xml" title rel="alternate" name="rss">
    <link href="https://habr.com/ru/articles/769102/" rel="canonical" data-hid="e3fa780">
    <link rel="image_src" href="https://habrastorage.org/getpro/habr/upload_files/28f/eab/4e1/28feab4e11d628c8e2f0149bf4282137.png" data-hid="2a79c45">
    <link rel="amphtml" href="https://habr.com/ru/amp/publications/769102/">
    <meta property="og:title" content="Распределённые транзакции">
    <meta name="twitter:title" content="Распределённые транзакции">
    <meta name="aiturec:title" content="Распределённые транзакции">
    <meta name="description" content="На собеседованиях на позицию middle/senior разработчика часто задают вопросы по распределенным транзакциям в микросервисной архитектуре. Мой коллега однажды посоветовал отличную статью со сравнением...">
    <meta itemprop="description" content="На собеседованиях на позицию middle/senior разработчика часто задают вопросы по распределенным транзакциям в микросервисной архитектуре. Мой коллега однажды посоветовал отличную статью со сравнением...">
    <meta property="og:description" content="На собеседованиях на позицию middle/senior разработчика часто задают вопросы по распределенным транзакциям в микросервисной архитектуре. Мой коллега однажды посоветовал отличную статью со сравнением...">
    <meta name="twitter:description" content="На собеседованиях на позицию middle/senior разработчика часто задают вопросы по распределенным транзакциям в микросервисной архитектуре. Мой коллега однажды посоветовал отличную статью со сравнением...">
    <meta property="aiturec:description" content="На собеседованиях на позицию middle/senior разработчика часто задают вопросы по распределенным транзакциям в микросервисной архитектуре. Мой коллега однажды посоветовал отличную статью со сравнением...">
    <meta itemprop="image" content="https://habrastorage.org/getpro/habr/upload_files/28f/eab/4e1/28feab4e11d628c8e2f0149bf4282137.png">
    <meta property="og:image" content="https://habrastorage.org/getpro/habr/upload_files/28f/eab/4e1/28feab4e11d628c8e2f0149bf4282137.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="aiturec:image" content="https://habrastorage.org/getpro/habr/upload_files/28f/eab/4e1/28feab4e11d628c8e2f0149bf4282137.png">
    <meta name="twitter:image" content="https://habrastorage.org/getpro/habr/upload_files/28f/eab/4e1/28feab4e11d628c8e2f0149bf4282137.png">
    <meta property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/28f/eab/4e1/28feab4e11d628c8e2f0149bf4282137.png?format=vk">
    <meta property="vk:image" content="https://habrastorage.org/getpro/habr/upload_files/28f/eab/4e1/28feab4e11d628c8e2f0149bf4282137.png?format=vk">
    <meta property="aiturec:item_id" content="769102">
    <meta property="aiturec:datetime" content="2023-10-22T11:31:04.000Z">
    <meta content="https://habr.com/ru/articles/769102/" property="og:url">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="ru_RU">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta name="keywords" content="java, распределенные системы, микросервисы, saga, паттерны, 2pc, оркестрация, хореография, архитектура, распределенные транзакции">
    <script type="application/ld+json" data-hid="1e0f0a2">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/articles\/769102\/"},"headline":"Распределённые транзакции","datePublished":"2023-10-22T14:31:04+03:00","dateModified":"2024-02-15T10:45:14+03:00","author":{"@type":"Person","name":"panyukovnikolay"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"На собеседованиях на позицию middle\/senior разработчика часто задают вопросы по распределенным транзакциям в микросервисной архитектуре.Мой коллега однажды посов...","url":"https:\/\/habr.com\/ru\/articles\/769102\/#post-content-body","about":["h_java","h_distributed_systems","h_microservices","f_develop","f_admin"],"image":["https:\/\/habr.com\/share\/publication\/769102\/3dd3d08f143000a551bb01db6c515e39\/","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/28f\/eab\/4e1\/28feab4e11d628c8e2f0149bf4282137.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/988\/822\/e36\/988822e36c51909e438cf6dac29fc1bd.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/77f\/017\/35c\/77f01735c2f721af38d359d26c4678d6.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/968\/68a\/e1c\/96868ae1c7f934c83f0888c6270697bc.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/fa0\/f47\/76d\/fa0f4776d8379c602eacec367c31e7ff.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/719\/821\/0af\/7198210af008b064fe2065c1acfa581c.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/eba\/193\/082\/eba193082c5b64fa5ca28a264e215a26.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/6ad\/d69\/78b\/6add6978bc81b99eb4cd5ba02b3648c0.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/55c\/2d5\/e1c\/55c2d5e1c2c98c9ab5f56aaab8edc568.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/a00\/bcb\/275\/a00bcb27585441d07e1f5af03c29ee9a.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/629\/77f\/b49\/62977fb49331af4b7a8ab5098b7db197.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/0d6\/a02\/d41\/0d6a02d41d342797249ff4d3e946fda9.png","https:\/\/habrastorage.org\/getpro\/habr\/upload_files\/b50\/09d\/a84\/b5009da84dcb2fd8974f8a1324d16875.png"]}</script>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,viewport-fit=cover,maximum-scale=1,user-scalable=0">
    <meta name="referrer" content="unsafe-url">
    <style>
        /* cyrillic-ext */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5VvmojLazX3dGTP.woff2) format('woff2');
            unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
        }

        /* cyrillic */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5Vvk4jLazX3dGTP.woff2) format('woff2');
            unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
        }

        /* latin-ext */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5VvmYjLazX3dGTP.woff2) format('woff2');
            unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
        }

        /* latin */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9E4kDNxMZdWfMOD5Vvl4jLazX3dA.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }

        /* cyrillic-ext */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 500;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveSxf6Xl7Gl3LX.woff2) format('woff2');
            unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
        }

        /* cyrillic */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 500;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveQhf6Xl7Gl3LX.woff2) format('woff2');
            unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
        }

        /* latin-ext */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 500;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveSBf6Xl7Gl3LX.woff2) format('woff2');
            unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
        }

        /* latin */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 500;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnZKveRhf6Xl7Glw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }

        /* cyrillic-ext */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eSxf6Xl7Gl3LX.woff2) format('woff2');
            unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
        }

        /* cyrillic */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eQhf6Xl7Gl3LX.woff2) format('woff2');
            unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
        }

        /* latin-ext */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eSBf6Xl7Gl3LX.woff2) format('woff2');
            unicode-range: U+0100-02AF, U+0304, U+0308, U+0329, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
        }

        /* latin */
        @font-face {
            font-family: 'Fira Sans';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/firasans/v17/va9B4kDNxMZdWfMOD5VnLK3eRhf6Xl7Glw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }
    </style>
    <link rel="preload" href="https://assets.habr.com/habr-web/css/theme/light-v1.css" as="style" media="(prefers-color-scheme: light)" /><link rel="preload" href="https://assets.habr.com/habr-web/css/theme/dark-v1.css" as="style" media="(prefers-color-scheme: dark)" /><link id="light-colors" rel="stylesheet" href="https://assets.habr.com/habr-web/css/theme/light-v1.css" media="(prefers-color-scheme: light)" /><link id="dark-colors" rel="stylesheet" href="https://assets.habr.com/habr-web/css/theme/dark-v1.css" media="(prefers-color-scheme: dark)" />
    <script>window.i18nFetch = new Promise((res, rej) => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', '/js/i18n/ru-compiled.635b6c39236ebd33fa716c71ab0131a0.json');
        xhr.responseType = 'json';
        xhr.onload = function(e) {
            if (this.status === 200) {
                res({ru: xhr.response});
            } else {
                rej(e);
            }
        };
        xhr.send();
    });</script>
    <style>
        .grecaptcha-badge {
            visibility: hidden;
        }
    </style>
    <meta name="habr-version" content="2.241.0">
    <meta name="csrf-token" content="1xBKisXF-k86JQvk3zVRMNXdTMJ_PA55xquo">
    <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
    <meta name="msapplication-TileColor" content="#629FBC">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="shortcut icon" type="image/png" sizes="16x16" href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png">
    <link rel="shortcut icon" type="image/png" sizes="32x32" href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png">
    <link rel="apple-touch-icon" type="image/png" sizes="76x76" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png">
    <link rel="apple-touch-icon" type="image/png" sizes="120x120" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png">
    <link rel="apple-touch-icon" type="image/png" sizes="152x152" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png">
    <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png">
    <link rel="apple-touch-icon" type="image/png" sizes="256x256" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png">
    <link rel="apple-touch-startup-image"
          media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
          href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png">
    <link rel="mask-icon" color="#77a2b6" href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg">
    <link crossorigin="use-credentials" href="/manifest.webmanifest" rel="manifest">
    <script async src="https://unpkg.com/pwacompat" crossorigin="anonymous"></script>
    <script>window.yaContextCb = window.yaContextCb || []</script>
    <script src="https://yandex.ru/ads/system/context.js" async></script>
    <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.04465f7c.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.978df117.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.8599692f.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.58b8c457.js" as="script"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.04465f7c.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.8599692f.css"></head>
<body>

<div id="mount"><div id="app"><div class="tm-layout__wrapper"><!--[--><!----><div></div><!----><header class="tm-header" data-test-id="header"><div class="tm-page-width"><!--[--><div class="tm-header__container"><!----><span class="tm-header__logo-wrap"><a class="tm-header__logo tm-header__logo_hl-ru tm-header__logo" href="/ru/"><svg class="tm-svg-img tm-header__icon" height="16" width="16"><title>Хабр</title><use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a><span style="display:none;" class="tm-header__beta-sign">β</span></span><!--[--><div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><!--[--><button class="tm-header__dropdown-toggle"><svg class="tm-svg-img tm-header__icon tm-header__icon_dropdown" height="16" width="16"><title>Открыть список</title><use xlink:href="/img/megazord-v28.7909a852..svg#arrow-down"></use></svg></button><!--]--></div><!----></div><a href="/ru/sandbox/start/" class="tm-header__become-author-btn">Как стать автором</a><div class="tm-feature tm-feature tm-feature_variant-inline tm-header__feature"><!----></div><!----><!--]--><!----></div><!--]--></div></header><div class="tm-layout"><div class="tm-page-progress-bar"></div><div class="tm-base-layout__header_is-sticky tm-base-layout__header" data-menu-sticky="true"><div class="tm-page-width"><!--[--><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/feed/">Моя лента</a><!--]--><!--[--><a class="tm-main-menu__item" href="/ru/flows/all/">Все потоки</a><!--]--><!--[--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/develop/">Разработка</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/admin/">Администрирование</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/design/">Дизайн</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/management/">Менеджмент</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/marketing/">Маркетинг</a><!--]--><!--[--><a class="tm-main-menu__item" data-test-id="main-menu-item" href="/ru/flows/popsci/">Научпоп</a><!--]--><!--]--></nav></div></div><div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search" data-test-id="search-button"><svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark" height="24" width="24"><title>Поиск</title><use xlink:href="/img/megazord-v28.7909a852..svg#search"></use></svg></a><a href="/ru/tracker/" class="tm-header-user-menu__item tm-header-user-menu__notifications" data-test-id="tracker-link"><svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_notifications tm-header-user-menu__icon_dark" height="24" width="24"><title>Трекер</title><use xlink:href="/img/megazord-v28.7909a852..svg#notifications"></use></svg><!----></a><!----><div class="tm-header-user-menu__item tm-header-user-menu__write"><div class="tm-dropdown write-dropdown"><div class="tm-dropdown__head"><!--[--><button class="tm-header-user-menu__toggle"><svg class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_write tm-header-user-menu__icon_dark" height="24" width="24"><title>Написать публикацию</title><use xlink:href="/img/megazord-v28.7909a852..svg#write"></use></svg></button><!--]--></div><!----></div><!----></div><div class="tm-header-user-menu__user_desktop tm-header-user-menu__item"><div class="tm-dropdown"><div class="tm-dropdown__head"><!--[--><div class="tm-entity-image" data-test-id="menu-toggle-user"><!--[--><img alt="" class="tm-entity-image__pic" height="32" src="https://assets.habr.com/habr-web/img/avatars/053.png" width="32"><!--]--></div><!----><!--]--></div><!----></div></div><!----><!--teleport start--><!--teleport end--><!----></div></div><!--]--></div></div><!----><div class="tm-page-width"><!--[--><!--]--></div><main class="tm-layout__container"><div class="tm-page" hl="ru" data-async-called="true" style="--5ab2e5a8:16px;--44c4f6f6:100%;--45ba7a3b:0;"><div class="tm-page-width"><!--[--><!----><div class="tm-page__wrapper"><div class="tm-page__main_has-sidebar tm-page__main"><div class="pull-down"><!----><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg class="tm-svg-img pull-down__icon pull-down__arrow" height="24" width="24"><title>Обновить</title><use xlink:href="/img/megazord-v28.7909a852..svg#pull-arrow"></use></svg></div></div><!--[--><!--[--><!----><div class="tm-article-presenter"><!--[--><!--]--><div class="tm-article-presenter__body" data-test-id="article-body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><!--[--><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><!--[--><div class="tm-article-presenter__header"><!--[--><!--]--><div class="tm-article-snippet tm-article-snippet tm-article-presenter__snippet"><!--[--><!--]--><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/panyukovnikolay/" class="tm-user-info__userpic" data-test-id="user-info-pic" title="panyukovnikolay"><div class="tm-entity-image"><!--[--><img alt="" class="tm-entity-image__pic" height="24" src="https://assets.habr.com/habr-web/img/avatars/053.png" width="24"><!--]--></div></a><span class="tm-user-info__user tm-user-info__user_appearance-default" data-test-id="user-info-description"><a href="/ru/users/panyukovnikolay/" class="tm-user-info__username">panyukovnikolay <!----></a><!--[--><span class="tm-article-datetime-published"><time datetime="2023-10-22T11:31:04.000Z" title="2023-10-22, 14:31">22  окт  2023 в 14:31</time></span><!--]--></span></span></div><div class="tm-article-snippet__controls"><!----><!--[--><a href="/ru/article/edit/769102/" class="tm-article-snippet__edit" data-test-id="newEditorlink"><svg class="tm-svg-img icon_edit-post" height="20" width="20" data-test-id="articleEditIcon"><title>Редактировать</title><use xlink:href="/img/megazord-v28.7909a852..svg#edit"></use></svg></a><!--]--><!--[--><!--[--><a class="statistics-link tm-article-snippet__stats-info" href="/ru/statistics/769102/" data-v-7093d44a><svg class="tm-svg-img icon_statistics-post" height="20" width="20" data-test-id="articleStatisticsIcon" data-v-7093d44a><title>Статистика</title><use xlink:href="/img/megazord-v28.7909a852..svg#stats-info"></use></svg></a><!--]--><!----><!--]--><!----></div></div><h1 class="tm-title tm-title_h1" lang="ru" data-test-id="articleTitle"><span>Распределённые транзакции</span></h1><div class="tm-article-snippet__stats" data-test-id="articleStats"><div class="tm-article-complexity tm-article-complexity_complexity-medium"><span class="tm-svg-icon__wrapper tm-article-complexity__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Уровень сложности</title><use xlink:href="/img/megazord-v28.7909a852..svg#complexity-medium"></use></svg></span><span class="tm-article-complexity__label">Средний</span></div><div class="tm-article-reading-time"><span class="tm-svg-icon__wrapper tm-article-reading-time__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Время на прочтение</title><use xlink:href="/img/megazord-v28.7909a852..svg#clock"></use></svg></span><span class="tm-article-reading-time__label">10 мин</span></div><span class="tm-icon-counter tm-data-icons__item"><svg class="tm-svg-img tm-icon-counter__icon" height="24" width="24"><title>Количество просмотров</title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-views"></use></svg><span class="tm-icon-counter__value" title="57171">57K</span></span></div><div class="tm-publication-hubs__container" data-test-id="articleHubsList"><div class="tm-publication-hubs"><!--[--><span class="tm-publication-hub__link-container"><a href="/ru/hubs/java/" class="tm-publication-hub__link tm-publication-hub__link_subscribed"><!--[--><span>Java</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span><!--]--></a></span><span class="tm-publication-hub__link-container"><a href="/ru/hubs/distributed_systems/" class="tm-publication-hub__link"><!--[--><span>Распределённые системы</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span><!--]--></a></span><span class="tm-publication-hub__link-container"><a href="/ru/hubs/microservices/" class="tm-publication-hub__link"><!--[--><span>Микросервисы</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб">*</span><!--]--></a></span><!--]--></div></div><div class="tm-article-labels" data-test-id="articleLabels"><div class="tm-article-labels__container"><!----><!--[--><div class="tm-publication-label tm-publication-label_variant-sandbox"><a href="/ru/sandbox/" class="">Из песочницы</a></div><div class="tm-publication-label tm-publication-label_variant-translation"><span>Перевод</span></div><!--]--></div></div><!----><!----></div></div><!--[--><div class="tm-article-presenter__origin"><a class="tm-article-presenter__origin-link" href="https://developers.redhat.com/articles/2021/09/21/distributed-transaction-patterns-microservices-compared" target="_blank">Автор оригинала: <span>Bilgin Ibryam</span></a></div><div class="tm-article-body" data-gallery-root lang="ru"><div><!--[--><!--]--></div><div id="post-content-body"><div><div class="article-formatted-body article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><p>На собеседованиях на позицию middle/senior разработчика часто задают вопросы по распределенным транзакциям в микросервисной архитектуре.</p><p>Мой коллега однажды посоветовал <a href="https://developers.redhat.com/articles/2021/09/21/distributed-transaction-patterns-microservices-compared" rel="noopener noreferrer nofollow">отличную статью</a> со сравнением основных паттернов для решения проблем распределённых транзакций.</p><p>Я проработал статью и подготовил конспект простыми словами, местами дополнил информацией из других источников и полезными ссылками.</p><p>Перед тем как начать, делюсь ссылкой на <a href="https://t.me/panyukovnikolay" rel="noopener noreferrer nofollow">мой блог в телеграм</a>, где я раньше всего публикую материалы по java разработке и личной эффективности.</p><hr/><h3>Оглавление</h3><ol><li><p>Проблема двойной записи</p></li><li><p>Модульный монолит</p></li><li><p>Двухфазный коммит</p></li><li><p>Оркестрация SAGA</p></li><li><p>Хореография SAGA<br/></p><ol><li><p>Хореография с двойной записью</p></li><li><p>Хореография без двойной записи</p></li><li><p>Хореография с Debezium</p></li><li><p>Хореография с event sourcing</p></li></ol></li><li><p>Parallel pipelines<br/></p><ol><li><p>Listen to yourself</p></li></ol></li><li><p>Общие выводы по всем паттернам</p></li></ol><hr/><p>В статье рассматриваются общие подходы к решению проблемы двойной записи, когда два микросервиса должны гарантировано, атомарно записать информацию в бд.</p><p>Каждый из рассмотренных вариантов имеет свои достоинства и недостатки, и может быть применен в промышленной разработке.</p><h2>Проблема двойной записи</h2><p>dual write problem</p><p>Главным индикатором проблемы двойной записи является необходимость атомарной записи в нескольких микросервисах.</p><p>Например:</p><ul><li><p>ваш сервис должен обновить свою бд и также уведомить другой сервис об изменениях</p></li><li><p>имеются транзакции, выполняемые в нескольких сервисах</p></li></ul><p>В нашем примере клиент вызывает микросервис А, который должен обновить бд, и данный сервис вызывает микросервис Б, который также должен выполнить операцию записи в свою бд.</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/28f/eab/4e1/28feab4e11d628c8e2f0149bf4282137.png" width="1380" height="1110" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/28f/eab/4e1/28feab4e11d628c8e2f0149bf4282137.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/28f/eab/4e1/28feab4e11d628c8e2f0149bf4282137.png 781w" loading="lazy" decode="async"/></figure><p>Здесь есть критичный момент, если уведомление об обновлении бд будет отправлено сервисом А после записи в бд А, то существует вероятность, что отправка прервется, из-за чего сервис Б останется в неконсистентном состоянии.</p><p>Если же сообщение будет отправлено перед записью в бд А, то есть вероятность, что запись в бд А прервется с ошибкой и сервис А останется неконсистентным.</p><p>Далее будут рассмотрены варианты решения данной проблемы</p><h2>Модульный монолит</h2><p>Modular monolith</p><p>Данный подход не является паттерном микросервисов, но на практике он работает хорошо, и может быть использован в микросервисной архитектуре в качестве комбинированного решения (какие-то сервисы будут представлять из себя монолитное решение, какие-то останутся микросервисами).</p><p>Подойдет, когда строгая связь между сервисами важнее, чем масштабируемость.</p><h2>Архитектура модульного монолита</h2><p>Наличие модульного монолита не означает что архитектура приложения плохая.</p><p>В данном подходе каждый из микросервисов А и Б является отдельной библиотекой, которые устанавливаются в общее пространство и имеют доступ к одной и той же бд.</p><p>Поскольку они находятся в одном пространстве и используют одну бд, они могут выполнять обработку в рамках одной и той же транзакции.</p><p>Тем не менее существует возможность полностью разделить два этих сервиса, даже в рамках одного монолита. Они могут смотреть на разные схемы, быть в разных пакетах, поддерживаться разными командами.</p><p>Иллюстрация разных уровней изоляции в монолитных и микросервисных архитектурах:<br/></p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/988/822/e36/988822e36c51909e438cf6dac29fc1bd.png" width="1856" height="1022" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/988/822/e36/988822e36c51909e438cf6dac29fc1bd.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/988/822/e36/988822e36c51909e438cf6dac29fc1bd.png 781w" loading="lazy" decode="async"/></figure><p>Последней частью данного подхода является сервис-обертка (например класс, который будет оборачивать вызовы модулей в транзакцию), который может использовать оба наших сервиса А и Б и включать их в контекст существующей транзакции.</p><p>Это увеличивает связность сервисов, но сервис-обертка позволяет запустить транзакцию, вызвать наши сервисы, обновить их бд, закоммитить или откатить транзакцию в рамках одной операции, сохраняя все в консистентном состоянии.</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/77f/017/35c/77f01735c2f721af38d359d26c4678d6.png" width="1484" height="1574" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/77f/017/35c/77f01735c2f721af38d359d26c4678d6.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/77f/017/35c/77f01735c2f721af38d359d26c4678d6.png 781w" loading="lazy" decode="async"/></figure><h3>Плюсы Модульного монолита:</h3><ul><li><p>простая семантика транзакций, позволяющая легко обеспечивать консистентность данных</p></li></ul><h3>Минусы Модульного монолита:</h3><ul><li><p>единый рантайм сервисов А и Б не позволяет нам независимо деплоить и масштабировать модули, а также обеспечивать отказоустойчивость</p></li><li><p>логическое разделение таблиц в рамках одной бд не является надежным, его могут захотеть изменить</p></li><li><p>транзакция увеличивает связность между сервисами</p></li></ul><p>Распределенных транзакций желательно избегать, однако они являются необходимыми в следующих случаях:</p><ul><li><p>когда записи в разные бд не могут быть согласованными</p></li><li><p>когда нам приходится писать в разнородные источники данных (например в две разные бд)</p></li><li><p>когда требуется однократная обработка сообщения и мы не можем сделать операции идемпотентными</p></li><li><p>при интеграции со сторонними black-box системами (такие системы мы не можем изменить) или устаревшими системами, которые реализуют спецификацию двухфазного коммита</p></li></ul><h2>Двухфазный коммит</h2><p>2 Phase Commit - 2PC</p><p>Технические требования для имплементации 2PC:</p><ul><li><p>наличие менеджера транзакций, например Narayana</p></li><li><p>надежное хранилище транзакционных логов</p></li><li><p>все бд, к которым подключены микросервисы должны иметь совместимость со стандартном DTP XA (distributed transaction processing) (XA - extended architecture), а также mq и кеши должны поддерживать XA драйвер</p></li><li><p>если у вас есть все необходимое, но при этом приложение деплоится в динамическое окружение, такое как Kubernetes, вам понадобиться некий управляющий механизм, который будет гарантировать, что есть только один экземпляр менеджера распределенных транзакций. Транзакционный менеджер должен быть всегда доступен и для него всегда должен быть обеспечен доступ к транзакционным логам. Пример Snowdrop Recovery Controller</p></li></ul><p>Пример работы 2PC в статье описан очень плохо, поэтому описание алгоритма 2PC взято из другого источника.</p><p>Код приложения в первую очередь обращается к координатору, получает номер транзакции.</p><p>С этим номером обращается к остальным системам, например к нескольким разным микросервисам, просит их внести изменения с указанным идентификатором транзакции</p><p>Затем приложение обращается к координатору с просьбой закоммитить транзакцию, после чего координатор сначала отправляет всем сигнал prepare, если все сервисы ответили успехом (они захватили write locks на своих бд), то им посылается сигнал commit.<br/></p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/968/68a/e1c/96868ae1c7f934c83f0888c6270697bc.png" width="1500" height="868" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/968/68a/e1c/96868ae1c7f934c83f0888c6270697bc.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/968/68a/e1c/96868ae1c7f934c83f0888c6270697bc.png 781w" loading="lazy" decode="async"/></figure><p>Теперь транзакция завершена.</p><p>Протокол двухфазного коммита появился в 70-х годах.</p><p>Двухфазный коммит предлагает те же гарантии что и единая транзакция в монолите, разве что возможны ошибки в данных при падении транзакционного менеджера.</p><h3>Плюсы 2PC</h3><ul><li><p>является стандартным решением, существуют готовые менеджеры транзакций и множество бд его поддерживают</p></li><li><p>строгая консистентность данных</p></li></ul><h3>Минусы 2PC</h3><ul><li><p>сложная конфигурация</p></li><li><p>низкая производительность</p></li><li><p>ограниченная масштабируемость (практически невозможно масштабировать)</p></li><li><p>возможные отказы, при падении менеджера транзакций</p></li><li><p>не все системы имеют поддержку (например NoSQL не интегрируются, mq или кеши могут не поддерживать спецификацию)</p></li><li><p>особые требования в динамических окружениях, таких как Kubernetes</p></li></ul><h2>Оркестрация SAGA</h2><p>Orchestration</p><p>В модульном монолите и 2PC мы гарантируем консистентность данных.</p><p>Но что если мы хотим ослабить требования к консистентности, при этом сохранив управление из одного места. В таком случае нам подойдет оркестрация. Когда один из сервисов выступает в качестве Оркестратора для всего состояния в распределенной системе.</p><p>Оркестратор несет ответственность за вызов сервисов, до тех пор пока они не достигнуть требуемого состояния или выполнит корректирующие действия в случае возникновения ошибки. Оркестратор использует свою бд для хранения состояния изменений и он ответственен за восстановление при любом падении в процессе изменения состояния.</p><h3>Внедрение архитектуры оркестрации</h3><p>Наиболее популярная имплементация - BPMN спецификация, пример jBPM или Camunda.</p><p>Есть также новые решение, которые не основываются на BPMN спецификации, но предлагают похожий подход - Conductor от Netflix, Cadence от Uber, Airflow от Apache.</p><p>Также к этой категории относятся serverless statefull functions такие как Amazon StepFunctions, Azure Durable Functions, Azure Logic Apps.</p><p>Есть opensource библиотеки, которые позволяют внедрить данное поведение - Apache Camel's Saga, NServiceBus Saga.</p><p>Множество доморощенных систем имплементируют паттерн Saga.</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/fa0/f47/76d/fa0f4776d8379c602eacec367c31e7ff.png" width="1888" height="1072" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/fa0/f47/76d/fa0f4776d8379c602eacec367c31e7ff.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/fa0/f47/76d/fa0f4776d8379c602eacec367c31e7ff.png 781w" loading="lazy" decode="async"/></figure><p>У нас есть сервис А, который выступает как оркестратор, он вызывает сервис Б и восстанавливается от падений с помощью компенсаторной операции при необходимости.</p><p>Ключевым моментом является то, что оба сервиса работают в своих локальных транзакциях<br/> В данном случае запрос от сервиса А к сервису Б будет выполнен в рамках транзакции.</p><p>Пример плохо прописан в статье, поэтому привожу более простое описание:<br/> Есть один сервис-оркестратор, который запускает транзакции в остальных сервисах и если что-то пошло не так, то вызывает соответствующие компенсирующие транзакции в этих сервисах, при этом выполнение каждого из шагов обновляет текущий статус операции.</p><p>Оркестрация является подходом с консистентностью в конечном счете, которая может включать в себя реатраи и роллбеки, для поддержки консистентного состояния.</p><p>Сервисы участники данного паттерна должны предоставлять идемпотентные операции, поскольку возможно выполнение ретраев, также они должны предоставлять эндпоинты для отката транзакций, чтобы сохранять согласованность данных.</p><p>Сильной стороной данного подхода является возможность разных сервисов, не поддерживающих распределенных транзакций, оставаться в консистентном состоянии используя только локальные транзакции.</p><p>При этом всегда можно узнать текущее состояние системы у координатора.</p><h3>Плюсы Оркестрации:</h3><ul><li><p>управление состоянием между разными сервисами в распределенной системе</p></li><li><p>нет необходимости в XA транзакциях</p></li><li><p>всегда можно узнать в каком состоянии находится система</p></li></ul><h3>Минусы Оркестрации:</h3><ul><li><p>сложная распределенная модель разработки</p></li><li><p>требует наличия идемпотентности и компенсаторных транзакций</p></li><li><p>согласованность в конечном счете</p></li><li><p>возможны невосстанавливаемые падения (unrecoverable failures) при выполнении компенсаторных транзакций</p></li></ul><h2>Хореография SAGA</h2><p>Choreography</p><p>Альтернативным решением для Оркестрации является Хореография - где нет оркестратора, управляющего всем процессом.</p><p>В данном паттерне каждый из сервисов выполняет локальную транзакцию и публикует события, которые вызывают локальные транзакции в остальных сервисах.</p><p>Каждый компонент системы участвует в принятии решения о судьбе транзакции. </p><p>Исторически сложилось, что самой популярной имплементацией хореографии является подход использующий асинхронный обмен сообщениями для взаимодействия между сервисами.</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/719/821/0af/7198210af008b064fe2065c1acfa581c.png" width="1862" height="968" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/719/821/0af/7198210af008b064fe2065c1acfa581c.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/719/821/0af/7198210af008b064fe2065c1acfa581c.png 781w" loading="lazy" decode="async"/></figure><h3>Хореография с двойной записью</h3><p>При использовании данного паттерна мы сталкиваемся с проблемой двойной записи, когда нам необходимо выполнить локальную транзакцию и отправить сообщение в очередь.</p><p>Здесь присутствуют те же недостатки:</p><ul><li><p>отправить сообщение затем закоммитить - является непрактичным решением, поскольку локальная транзакция может откатиться, а сообщение уже будет отправлено</p></li><li><p>закоммитить транзакцию и затем отправить сообщение - остается возможность падения приложения после коммита транзакции и перед отправкой сообщения. Однако данное решение лучше, поскольку можно задизайнить приложение таким образом, чтобы выполнялись ретраи</p></li></ul><h3>Хореография без двойной записи</h3><p>Одним из возможных решений является запись в рамках одной транзакции в бд и никуда не отправлять сообщение.</p><p>Пример - Сервис А сохраняет запрос и пишет в бд А. Сервис Б периодически опрашивает Сервис А и находит изменения, при обнаружении изменений Сервис Б обновляет свою бд.</p><p>Важнейшей частью данного подхода является то, что оба сервиса выполняют запись в свои бд в рамках локальных транзакций.</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/eba/193/082/eba193082c5b64fa5ca28a264e215a26.png" width="1852" height="1190" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/eba/193/082/eba193082c5b64fa5ca28a264e215a26.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/eba/193/082/eba193082c5b64fa5ca28a264e215a26.png 781w" loading="lazy" decode="async"/></figure><p>В данном подходе сервис Б смотрит напрямую в бд А.<br/>Что выстраивает жесткую связность между сервисами, поскольку изменения в структуре бд на стороне сервиса А влекут за собой изменения на стороне сервиса Б.</p><p>Мы можем улучшить данный подход, создав на стороне сервиса А отдельную таблицу, которую будет читать Б, что упрощает внесение изменений.</p><p>Либо пойти дальше и создать на стороне сервиса А API для подключению к бд А.</p><p>Однако данный подход страдает от одного недостатка - необходимость постоянно запрашивать сервисом Б данные из сервиса А.</p><h3>Хореография с Debezium</h3><p>Один из вариантов сделать хореографию более удобной - использовать инструмент наподобие Debezium, который может отследить обновления в Сервисе А, захватывая изменение данных бд (CDC - change data capture), используя транзакционный лог базы данных А.</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/6ad/d69/78b/6add6978bc81b99eb4cd5ba02b3648c0.png" width="1836" height="862" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/6ad/d69/78b/6add6978bc81b99eb4cd5ba02b3648c0.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/6ad/d69/78b/6add6978bc81b99eb4cd5ba02b3648c0.png 781w" loading="lazy" decode="async"/></figure><p>Debezium умеет отслеживать транзакционный лог в ожидании необходимых событий, после чего отправлять их в Apache Kafka.</p><p>Сервис Б слушает топик в Kafka, вместо того, чтобы опрашивать сервис А.</p><p>Такой подход более надежный и масштабируемый.</p><p>Возможный сайд эффект - сервис Б может получить одно и то же сообщение дважды, это может быть исправлено, если сделать сервис Б идемпотентным, или использовать подход дедубликации (Apache Active MQ duplicate message detection, Apache Camel's idempotent consumer pattern).</p><p>Данный вариант является примером паттерна Transactional Outbox, однако про него стоит почитать отдельно в <a href="https://microservices.io/patterns/data/transactional-outbox.html" rel="noopener noreferrer nofollow">данной статье</a>.</p><h3>Хореография с Event sourcing</h3><p>При данном подходе состояние сущности хранится как последовательность событий, меняющих это состояние.</p><p>Атомарное добавление записи об обновлении состояния записывается в бд с помощью локальной транзакции.</p><p>При этом хранилище событий также выступает как mq для других сервисов.</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/55c/2d5/e1c/55c2d5e1c2c98c9ab5f56aaab8edc568.png" width="1872" height="1158" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/55c/2d5/e1c/55c2d5e1c2c98c9ab5f56aaab8edc568.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/55c/2d5/e1c/55c2d5e1c2c98c9ab5f56aaab8edc568.png 781w" loading="lazy" decode="async"/></figure><p>В приведенном примере запросы клиента будут храниться в append-only хранилище событий.</p><p>Также хранилище событий должно позволять Сервису Б быть подписанным на него.</p><p>Тем самым Сервис А использует свое хранилище для коммуникации с другими сервисами.</p><p>Event sourcing является непривычным подходом к программированию и добавляет сложность для воспроизведения состояния сущности.</p><p>Про него также стоит почитать подробнее <a href="https://microservices.io/patterns/data/event-sourcing.html" rel="noopener noreferrer nofollow">в данной статье</a>.</p><h3>Плюсы Хореографии</h3><ul><li><p>убирает связность между реализацией и взаимодействием</p></li><li><p>нет единого координатора</p></li><li><p>улучшенная масштабируемость и устойчивость</p></li><li><p>проще при использовании соответствующих инструментов, таких как Debezium</p></li></ul><h3>Минусы Хореографии</h3><ul><li><p>глобальное состояние системы распределено по сервисам-участникам (сложно узнать текущее состояние)</p></li><li><p>согласованность в конечном счете</p></li></ul><h2>Parallel pipelines</h2><p>Предыдущие паттерны предлагают нам последовательную обработку входящего запроса, однако возможна ситуация когда один и тот же запрос должен обрабатываться разными сервисами параллельно.</p><p>Данный паттерн подразумевает возможность параллельно обрабатывать запросы, когда между сервисом А и сервисом Б нет прямой зависимости.</p><p>Добавляется сервис router, который будет посылать сообщения в оба сервиса в рамках одной транзакции.</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/a00/bcb/275/a00bcb27585441d07e1f5af03c29ee9a.png" width="1850" height="1798" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/a00/bcb/275/a00bcb27585441d07e1f5af03c29ee9a.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/a00/bcb/275/a00bcb27585441d07e1f5af03c29ee9a.png 781w" loading="lazy" decode="async"/></figure><h3>Listen to yourself</h3><p>Еще одним вариантом parellel pipelines является ситуация, когда один из сервисов сам выступает роутером.</p><p>Тогда сервис А при получении сообщения кладет его в брокер сообщений, откуда оно будет считано как сервисом А, так и сервисом Б.</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/629/77f/b49/62977fb49331af4b7a8ab5098b7db197.png" width="1816" height="1016" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/629/77f/b49/62977fb49331af4b7a8ab5098b7db197.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/629/77f/b49/62977fb49331af4b7a8ab5098b7db197.png 781w" loading="lazy" decode="async"/></figure><h3>Плюсы Parallel Pipelines:</h3><ul><li><p>простая, масштабируемая архитектура для параллельной обработки</p></li></ul><h3>Минусы Parallel Pipelines:</h3><ul><li><p>сложно понять в каком состоянии находится системам в конкретный момент времени</p></li></ul><h2>Общие выводы по всем паттернам</h2><p>Нет единого подхода для решения проблемы распределенных транзакций. </p><p>Каждый паттерн имеет свои достоинства и недостатки, решая свою конкретную проблему.</p><p>Таблица с характеристикой каждого подхода:</p><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/0d6/a02/d41/0d6a02d41d342797249ff4d3e946fda9.png" width="1826" height="916" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/0d6/a02/d41/0d6a02d41d342797249ff4d3e946fda9.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/0d6/a02/d41/0d6a02d41d342797249ff4d3e946fda9.png 781w" loading="lazy" decode="async"/></figure><figure class="full-width "><img src="https://habrastorage.org/r/w1560/getpro/habr/upload_files/b50/09d/a84/b5009da84dcb2fd8974f8a1324d16875.png" width="1890" height="1036" sizes="(max-width: 780px) 100vw, 50vw" srcset="https://habrastorage.org/r/w780/getpro/habr/upload_files/b50/09d/a84/b5009da84dcb2fd8974f8a1324d16875.png 780w,&#10;       https://habrastorage.org/r/w1560/getpro/habr/upload_files/b50/09d/a84/b5009da84dcb2fd8974f8a1324d16875.png 781w" loading="lazy" decode="async"/></figure><h3>Высокая масштабируемость: Parallel pipelines и Хореография</h3><p>Если сервисы не связаны между собой, то стоит использовать паттерн Parallel pipelines.</p><p>Если вам нужна обработка по порядку, то стоит использовать паттерн Хореография.</p><h3>Средняя масштабируемость: Оркестрация</h3><p>Если хореография не подходит и вам нужен центральный сервис, ответственный за координацию, то вам подойдет оркестрация.</p><h3>Низкая масштабируемость: Модульный монолит и 2PC</h3><p>Если вам нужна строгая консистентность данных, то вам подойдет 2PC, но он имеет свои требования к софту, а также его сложно имплементировать на современных отказоустойчивых кластерах.</p><p>Поэтому лучше использовать модульный монолит.</p><p>В большой распределенной системе скорее всего будет применен не один, а сразу несколько из описанных подходов, которые стоит применять по необходимости.</p><p></p></div></div></div><!----><!----></div><!----><!----></div><!--]--><!----><div class="tm-article-presenter__meta" data-test-id="article-meta-links"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span><ul class="tm-separated-list__list"><!--[--><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[java]" class="tm-tags-list__link"><span>java</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D1%80%D0%B0%D1%81%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5+%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B]" class="tm-tags-list__link"><span>распределенные системы</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D0%BC%D0%B8%D0%BA%D1%80%D0%BE%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B]" class="tm-tags-list__link"><span>микросервисы</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[saga]" class="tm-tags-list__link"><span>saga</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D0%BF%D0%B0%D1%82%D1%82%D0%B5%D1%80%D0%BD%D1%8B]" class="tm-tags-list__link"><span>паттерны</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[2pc]" class="tm-tags-list__link"><span>2pc</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D0%BE%D1%80%D0%BA%D0%B5%D1%81%D1%82%D1%80%D0%B0%D1%86%D0%B8%D1%8F]" class="tm-tags-list__link"><span>оркестрация</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D1%85%D0%BE%D1%80%D0%B5%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D1%8F]" class="tm-tags-list__link"><span>хореография</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D0%B0%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0]" class="tm-tags-list__link"><span>архитектура</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D1%80%D0%B0%D1%81%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5+%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B0%D0%BA%D1%86%D0%B8%D0%B8]" class="tm-tags-list__link"><span>распределенные транзакции</span></a><!--]--></li><!--]--><!----></ul></div><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span><ul class="tm-separated-list__list"><!--[--><li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/java/" class="tm-hubs-list__link"><!--[--><span>Java</span><!--]--></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/distributed_systems/" class="tm-hubs-list__link"><!--[--><span>Распределённые системы</span><!--]--></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/microservices/" class="tm-hubs-list__link"><!--[--><span>Микросервисы</span><!--]--></a><!--]--></li><!--]--><!----></ul></div></div><!----><!--]--></article><!--]--></div><!----></div><div style="" class="tm-article-sticky-panel" data-test-id="article-sticky-panel"><div class="tm-data-icons tm-data-icons tm-data-icons_space-big tm-article-sticky-panel__icons" data-test-id="article-stats-icons"><div class="article-rating tm-data-icons__item" data-v-86aec4a7><div class="tm-votes-meter votes-switcher" data-v-86aec4a7><svg class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon tm-votes-meter__icon_appearance-article" height="24" width="24"><title>Всего голосов 22: ↑19 и ↓3</title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-rating"></use></svg><span class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_appearance-article tm-votes-meter__value_rating tm-votes-meter__value" data-test-id="votes-meter-value" title="Всего голосов 22: ↑19 и ↓3">+20</span></div><!--teleport start--><!--teleport end--><!----></div><!----><!----><button class="bookmarks-button tm-data-icons__item" title="Добавить в закладки" type="button"><span class="tm-svg-icon__wrapper bookmarks-button__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Добавить в закладки</title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-favorite"></use></svg></span><span class="bookmarks-button__counter" title="Количество пользователей, добавивших публикацию в закладки">333</span></button><div class="tm-sharing tm-data-icons__item" title="Поделиться"><button class="tm-sharing__button" type="button"><svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="tm-sharing__icon"><path fill="currentColor" d="M13.8 13.8V18l7.2-6.6L13.8 5v3.9C5 8.9 3 18.6 3 18.6c2.5-4.4 6-4.8 10.8-4.8z"></path></svg></button><!--teleport start--><!--teleport end--></div><div class="tm-article-comments-counter-link tm-data-icons__item" title="Читать комментарии"><a href="/ru/articles/769102/comments/" class="tm-article-comments-counter-link__link" data-test-id="counter-comments"><!--[--><svg class="tm-svg-img tm-article-comments-counter-link__icon" height="24" width="24"><title>Комментарии</title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-comments"></use></svg><span class="tm-article-comments-counter-link__value">5</span><!--]--></a><a href="/ru/articles/769102/comments/#first_unread" class="tm-article-comments-counter-link__link" data-test-id="unread-count"><!--[--><div class="tm-article-comments-counter-link__unread-counter tm-article-comments-counter-link__unread-counter_roundOnMobile" title="Читать новые комментарии"><span>+4</span></div><!--]--></a></div><!--[--><!--[--><!--[--><!----><!--]--><!--]--><!--]--><!--teleport start--><!--teleport end--><!----></div></div></div><!--[--><!--]--><div class="tm-article-presenter__footer"><!--[--><!--[--><div class="tm-article-blocks"><!----><!--[--><section class="tm-block tm-block tm-block_spacing-bottom"><!----><!--[--><div class="tm-block__body tm-block__body tm-block__body_variant-balanced"><!--[--><div class="tm-article-author" data-test-id="article-author-info" data-async-called="true"><!--[--><!--]--><div class="tm-user-card tm-user-card tm-user-card_variant-article tm-article-author__user-card" data-async-called="true"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/panyukovnikolay/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><!--[--><img alt="" class="tm-entity-image__pic" src="https://assets.habr.com/habr-web/img/avatars/053.png"><!--]--></div></a><div class="tm-user-card__meta"><div class="tm-counter-container karma" title=" 18 голосов " data-v-f7c0e283><div class="tm-counter-container__header"><!--[--><div class="karma-display positive" data-v-f7c0e283 data-v-7635202e>14</div><!----><!--]--></div><div class="tm-counter-container__footer"><!--[--><div class="karma-text" data-v-f7c0e283>Карма</div><!--teleport start--><!--teleport end--><!--]--></div></div><div class="tm-counter-container" title="Рейтинг пользователя"><div class="tm-counter-container__header"><!--[--><!--[--><!--]--><div class="tm-votes-lever tm-votes-lever tm-votes-lever_appearance-rating"><!----><div class="tm-votes-lever__score tm-votes-lever__score_appearance-rating tm-votes-lever__score"><!--[--><span><span class="tm-votes-lever__score-counter tm-votes-lever__score-counter_rating tm-votes-lever__score-counter" data-test-id="votes-score-counter">0</span></span><!--]--></div><!----></div><!--]--></div><div class="tm-counter-container__footer"><!--[--><span class="tm-rating__text tm-rating__text">Рейтинг</span><!--]--></div></div></div></div></div><div class="tm-user-card__info tm-user-card__info_variant-article tm-user-card__info"><div class="tm-user-card__title tm-user-card__title_variant-article tm-user-card__title"><!----><a href="/ru/users/panyukovnikolay/" class="tm-user-card__nickname tm-user-card__nickname tm-user-card__nickname_variant-article"> @panyukovnikolay</a><!----></div><p class="tm-user-card__short-info tm-user-card__short-info_variant-article tm-user-card__short-info" data-test-id="user-card-speciality">Пользователь</p></div></div><!----><div class="tm-user-card__buttons tm-user-card__buttons_variant-article tm-user-card__buttons"><!----><!----><!----><!----><!----></div><!----></div><div class="tm-article-author__user-contacts" data-test-id="author-contacts"><!----><!----><!----></div></div><!--]--></div><!--]--><!----></section><!----><!--[--><div class="banner-wrapper leaderboard tm-page-article__banner" style="--38f3d936:200px;--78a3cd06:auto;" data-v-f4bf0d24><!--[--><div class="placeholder-wrapper placeholder" data-v-f4bf0d24><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><div class="adfox-banner-placeholder leaderboard" data-v-12f7bcca><div class="image loads" data-v-12f7bcca></div><div class="lines" data-v-12f7bcca><div class="line loads" data-v-12f7bcca></div><div class="line loads" data-v-12f7bcca></div><div class="line loads" data-v-12f7bcca></div></div></div><!----><!----><!----></div><div id="adfox_164725660339535756" class="tm-adfox-banner" data-v-f4bf0d24></div><!--]--></div><!--]--><!--]--><div class="tm-article-blocks__comments"><div id="publication-comments" class="tm-article-page-comments"><div><!--[--><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/articles/769102/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style" data-test-id="counter-comments"><!--[--><svg class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted" height="24" width="24"><title>Комментарии</title><use xlink:href="/img/megazord-v28.7909a852..svg#counter-comments"></use></svg><span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted"> Комментарии 5 </span><!--]--></a><a href="/ru/articles/769102/comments/#first_unread" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style" data-test-id="unread-count"><!--[--><div class="tm-article-comments-counter-link__unread-counter tm-article-comments-counter-link__unread-counter_contrasted tm-article-comments-counter-link__unread-counter_roundOnMobile" title="Читать новые комментарии"><span>+4</span></div><!--]--></a></div><!--]--></div></div></div><!--[--><!--[--><!--]--><section class="tm-block tm-block tm-block_spacing-bottom"><header class="tm-block__header tm-block__header tm-block__header_variant-borderless"><div class="tm-block__header-container"><h2 class="tm-block__title tm-block__title tm-block__title_variant-large">Публикации</h2><!--[--><!--]--></div><!----></header><!--[--><div class="tm-block__body tm-block__body tm-block__body_variant-condensed-slim"><!--[--><!--[--><div class="tm-tabs tm-tabs"><div class=""><!--[--><span class="tm-tabs__tab-item"><button class="tm-tabs__tab-link tm-tabs__tab-link_active tm-tabs__tab-link_slim tm-tabs__tab-link">Лучшие за сутки</button></span><span class="tm-tabs__tab-item"><button class="tm-tabs__tab-link tm-tabs__tab-link_slim tm-tabs__tab-link">Похожие</button></span><!--]--></div><!----></div><div class="similar-and-daily__tab-view"><div class="daily-articles-list"><ul class="tm-article-card-list"><!--[--><!--]--><div class="tm-bordered-card"><!----><!--[--><!--]--></div></ul><div class="daily-articles-block__button-container"><button class="btn btn_transparent btn_small tm-button tm-button_color-horizon" type="button"><!--[--><!--[-->Показать лучшие за всё время<!--]--><!--]--></button></div></div><!----></div><!--]--><!--]--></div><!--]--><!----></section><!--[--><div><div class="placeholder-wrapper"><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><div class="tm-placeholder-promo"><div class="tm-placeholder-promo__header"><div class="tm-placeholder__line tm-placeholder__line_promo-title"></div></div><div class="tm-placeholder-promo__body"><div class="tm-placeholder-promo__posts"><div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div><div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div><div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div><div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div><div class="tm-placeholder-promo__post"><div class="tm-placeholder-promo__image"></div><div class="tm-placeholder__line tm-placeholder__line_post-title"></div></div></div><div class="tm-placeholder-promo__dots"><div class="tm-placeholder-promo__dot"></div><div class="tm-placeholder-promo__dot"></div><div class="tm-placeholder-promo__dot"></div></div></div></div><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----></div></div><div class="placeholder-wrapper"><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><div class="tm-placeholder-inset tm-placeholder-questions"><div class="tm-placeholder-inset__header"><div class="tm-placeholder__line tm-placeholder__line_inset-header loads"></div></div><div class="tm-placeholder-inset__body"><ul class="tm-placeholder-list"><!--[--><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><li class="tm-placeholder-list__item tm-placeholder-list__item_inset"><div class="tm-placeholder__line tm-placeholder__line_item-title loads"></div><div class="tm-project-block-items__properties"><!--[--><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><span class="tm-project-block-items__property-item"><span class="tm-placeholder__line loads" style="width:100px;"></span></span><!--]--></div></li><!--]--></ul></div><div class="tm-placeholder-inset__footer"><div class="tm-placeholder__line tm-placeholder__line_inset-footer loads"></div></div></div><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----></div><!--]--><!----><!--[--><!--]--><!--]--></div><!--]--><!--]--></div></div><!--]--><!--]--></div></div><div class="tm-page__sidebar"><!--[--><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__placeholder_initial"></div><div class="tm-sexy-sidebar_initial tm-sexy-sidebar" style="margin-top:0px;"><!--[--><!--]--><!----><div class="tm-layout-sidebar__ads_initial tm-layout-sidebar__ads"><div class="banner-wrapper half-page tm-layout-sidebar__banner tm-layout-sidebar__banner_top" style="--38f3d936:600px;--78a3cd06:auto;" data-v-f4bf0d24><!--[--><div class="placeholder-wrapper placeholder" data-v-f4bf0d24><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><div class="adfox-banner-placeholder half-page" data-v-12f7bcca><div class="image loads" data-v-12f7bcca></div><div class="lines" data-v-12f7bcca><div class="line loads" data-v-12f7bcca></div><div class="line loads" data-v-12f7bcca></div><div class="line loads" data-v-12f7bcca></div></div></div><!----><!----><!----></div><div id="adfox_164725680533065327" class="tm-adfox-banner" data-v-f4bf0d24></div><!--]--></div></div><!--[--><!----><div></div><section class="tm-block tm-block tm-block_spacing-around" data-async-called="true"><header class="tm-block__header tm-block__header"><div class="tm-block__header-container"><h2 class="tm-block__title tm-block__title">Работа</h2><!--[--><!--]--></div><!----></header><!--[--><div class="tm-block__body tm-block__body"><!--[--><!--[--><div class="tm-vacancies-block__item"><a class="tm-vacancies-block__vacancy-title" href="https://career.habr.com/vacancies/blockchain_developer" target="_blank">Blockchain разработчик</a><div class="tm-vacancies-block__vacancies-count">0
    вакансий</div></div><div class="tm-vacancies-block__item"><a class="tm-vacancies-block__vacancy-title" href="https://career.habr.com/vacancies/java_developer" target="_blank">Java разработчик</a><div class="tm-vacancies-block__vacancies-count">197
    вакансий</div></div><!--]--><!--]--></div><!--]--><footer class="tm-block__footer"><!--[--><a class="tm-block-extralink" href="https://career.habr.com/catalog">Все вакансии</a><!--]--></footer></section><section class="tm-block tm-block tm-block_spacing-around block" data-v-6f380946><header class="tm-block__header tm-block__header"><div class="tm-block__header-container"><h2 class="tm-block__title tm-block__title">Ближайшие события</h2><!--[--><!--]--></div><!----></header><!--[--><div class="tm-block__body tm-block__body"><!--[--><div class="placeholder-wrapper" data-v-6f380946><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><section class="tm-block tm-block tm-block_spacing-none" tabindex="-1" data-v-9caf0b82><!----><!--[--><div class="event-card-placeholder is-widget" data-v-9caf0b82><div class="image loads" data-v-9caf0b82></div><div class="info" data-v-9caf0b82><div class="date line" data-v-9caf0b82></div><div class="title line" data-v-9caf0b82></div><div class="places line" data-v-9caf0b82></div><div class="places line" data-v-9caf0b82></div></div><div class="footer widget" data-v-9caf0b82><div class="link line" data-v-9caf0b82></div><div class="categories" data-v-9caf0b82><!--[--><div class="category line" data-v-9caf0b82></div><div class="category line" data-v-9caf0b82></div><div class="category line" data-v-9caf0b82></div><!--]--></div></div></div><!--]--><!----></section><!----></div><!--]--></div><!--]--><!----></section><!--]--><div class="banner-wrapper medium-rectangle tm-layout-sidebar__banner tm-layout-sidebar__banner_bottom" style="--38f3d936:250px;--78a3cd06:auto;" data-v-f4bf0d24><!--[--><div class="placeholder-wrapper placeholder" data-v-f4bf0d24><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><div class="adfox-banner-placeholder medium-rectangle" data-v-12f7bcca><div class="image loads" data-v-12f7bcca></div><div class="lines" data-v-12f7bcca><div class="line loads" data-v-12f7bcca></div><div class="line loads" data-v-12f7bcca></div><div class="line loads" data-v-12f7bcca></div></div></div><!----><!----><!----></div><div id="adfox_164725691003361602" class="tm-adfox-banner" data-v-f4bf0d24></div><!--]--></div></div></div><!--]--></div></div><!----><!--]--></div></div></main><!----></div><div class="tm-footer-menu"><div class="tm-page-width"><!--[--><div class="tm-footer-menu__container"><!--[--><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Ваш аккаунт</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="/ru/users/panyukovnikolay/articles/" class="footer-menu__item-link">Профиль</a></li><li class="tm-footer-menu__list-item"><a href="/ru/tracker/" class="footer-menu__item-link">Трекер</a></li><li class="tm-footer-menu__list-item"><a href="/ru/conversations/" class="footer-menu__item-link">Диалоги</a></li><li class="tm-footer-menu__list-item"><a href="/ru/settings/profile/" class="footer-menu__item-link">Настройки</a></li><li class="tm-footer-menu__list-item"><a href="/ru/ppa/" class="footer-menu__item-link">ППА</a></li><!--]--></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Разделы</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="/ru/articles/" class="footer-menu__item-link">Статьи</a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">Новости</a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">Хабы</a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">Компании</a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">Авторы</a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">Песочница</a></li><!--]--></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Информация</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">Устройство сайта</a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">Для авторов</a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">Для компаний</a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">Документы</a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement/?hl=ru_RU" target="_blank">Соглашение</a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/?hl=ru_RU" target="_blank">Конфиденциальность</a></li><!--]--></ul></div></div><div class="tm-footer-menu__block"><p class="tm-footer-menu__block-title">Услуги</p><div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><!--[--><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/corporate-blogs/" target="_blank">Корпоративный блог</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/advertising/" target="_blank">Медийная реклама</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/native-special/" target="_blank">Нативные проекты</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/education-programs/" target="_blank">Образовательные программы</a></li><li class="tm-footer-menu__list-item"><a href="https://company.habr.com/ru/hello-startup/" target="_blank">Стартапам</a></li><!--]--></ul></div></div><!--]--></div><!--]--></div></div><div class="tm-footer"><div class="tm-page-width"><!--[--><div class="tm-footer__container"><!----><div class="tm-footer__social"><!--[--><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Facebook</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Twitter</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>VK</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-vk"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Telegram</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Youtube</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a class="tm-svg-icon__wrapper tm-social-icons__icon" href="https://dzen.ru/habr" rel="nofollow noopener noreferrer" target="_blank"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Яндекс Дзен</title><use xlink:href="/img/new-social-icons-sprite.svg#social-logo-dzen"></use></svg></a><!--]--></div><!--teleport start--><!--teleport end--><button class="tm-footer__link"><!----> Настройка языка</button><a href="/ru/feedback/" class="tm-footer__link">Техническая поддержка</a><div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2025, </span><span class="tm-copyright__name"><a class="tm-copyright__link" href="https://company.habr.com/" rel="noopener" target="_blank">Habr</a></span></span></div></div><!--]--></div></div><!----><!--]--></div><!----></div><script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"769102":{"id":"769102","timePublished":"2023-10-22T11:31:04+00:00","isCorporative":false,"lang":"ru","titleHtml":"Распределённые транзакции","leadData":{"textHtml":"\u003Cp\u003EНа собеседованиях на позицию middle\u002Fsenior разработчика часто задают вопросы по распределенным транзакциям в микросервисной архитектуре.\u003C\u002Fp\u003E\u003Cp\u003EМой коллега однажды посоветовал \u003Ca href=\"https:\u002F\u002Fdevelopers.redhat.com\u002Farticles\u002F2021\u002F09\u002F21\u002Fdistributed-transaction-patterns-microservices-compared\" rel=\"noopener noreferrer nofollow\"\u003Eотличную статью\u003C\u002Fa\u003E со сравнением основных паттернов для решения проблем распределённых транзакций.\u003C\u002Fp\u003E\u003Cp\u003EЯ проработал статью и подготовил конспект простыми словами, местами дополнил информацией из других источников и полезными ссылками.\u003C\u002Fp\u003E\u003Cp\u003EПеред тем как начать, делюсь ссылкой на \u003Ca href=\"https:\u002F\u002Ft.me\u002F+o7WnufXXU1c4Yjli\" rel=\"noopener noreferrer nofollow\"\u003Eмой блог в телеграм\u003C\u002Fa\u003E, где я раньше всего публикую материалы по java разработке и личной эффективности.\u003C\u002Fp\u003E\u003Cp\u003E\u003C\u002Fp\u003E","imageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F28f\u002Feab\u002F4e1\u002F28feab4e11d628c8e2f0149bf4282137.png","buttonTextHtml":"Читать далее","image":{"url":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F28f\u002Feab\u002F4e1\u002F28feab4e11d628c8e2f0149bf4282137.png","fit":"cover","positionY":0,"positionX":0}},"editorVersion":"2.0","postType":"article","postLabels":[{"type":"sandbox","typeOf":"system","title":"Из песочницы","data":{"url":null}},{"type":"translation","typeOf":"system","title":"Перевод","data":{"originalAuthorName":"Bilgin Ibryam","originalUrl":"https:\u002F\u002Fdevelopers.redhat.com\u002Farticles\u002F2021\u002F09\u002F21\u002Fdistributed-transaction-patterns-microservices-compared"}}],"author":{"id":"3835876","alias":"panyukovnikolay","fullname":null,"avatarUrl":null,"speciality":null,"scoreStats":{"score":14,"votesCount":18},"rating":0,"relatedData":{"vote":{"value":null},"canVote":false,"votePlus":{"canVote":false,"isKarmaEnough":true,"isChargeEnough":true,"isPublicationLimitEnough":true},"voteMinus":{"canVote":false,"isKarmaEnough":true,"isChargeEnough":true,"isPublicationLimitEnough":true},"isSubscribed":false},"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"donationsMethod":null,"isInBlacklist":false,"careerProfile":null},"statistics":{"commentsCount":5,"favoritesCount":333,"readingCount":57171,"score":20,"votesCount":22,"votesCountPlus":19,"votesCountMinus":3},"hubs":[{"id":"375","alias":"java","type":"collective","title":"Java","titleHtml":"Java","isProfiled":true,"relatedData":{"isSubscribed":true}},{"id":"21482","alias":"distributed_systems","type":"collective","title":"Распределённые системы","titleHtml":"Распределённые системы","isProfiled":true,"relatedData":{"isSubscribed":false}},{"id":"22115","alias":"microservices","type":"collective","title":"Микросервисы","titleHtml":"Микросервисы","isProfiled":true,"relatedData":{"isSubscribed":false}}],"flows":[{"id":"1","alias":"develop","title":"Разработка","titleHtml":"Разработка"},{"id":"6","alias":"admin","title":"Администрирование","titleHtml":"Администрирование"}],"relatedData":{"vote":{"value":null,"voteTimeExpired":"2023-11-21T11:31:04+00:00"},"unreadCommentsCount":4,"bookmarked":false,"canComment":true,"canEdit":true,"canViewVotes":true,"votePlus":{"canVote":false,"isChargeEnough":true,"isKarmaEnough":true,"isVotingOver":true,"isPublicationLimitEnough":true},"voteMinus":{"canVote":false,"isChargeEnough":true,"isKarmaEnough":true,"isVotingOver":true,"isPublicationLimitEnough":true},"canModerateComments":true,"trackerSubscribed":false,"emailSubscribed":false},"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cp\u003EНа собеседованиях на позицию middle\u002Fsenior разработчика часто задают вопросы по распределенным транзакциям в микросервисной архитектуре.\u003C\u002Fp\u003E\u003Cp\u003EМой коллега однажды посоветовал \u003Ca href=\"https:\u002F\u002Fdevelopers.redhat.com\u002Farticles\u002F2021\u002F09\u002F21\u002Fdistributed-transaction-patterns-microservices-compared\" rel=\"noopener noreferrer nofollow\"\u003Eотличную статью\u003C\u002Fa\u003E со сравнением основных паттернов для решения проблем распределённых транзакций.\u003C\u002Fp\u003E\u003Cp\u003EЯ проработал статью и подготовил конспект простыми словами, местами дополнил информацией из других источников и полезными ссылками.\u003C\u002Fp\u003E\u003Cp\u003EПеред тем как начать, делюсь ссылкой на \u003Ca href=\"https:\u002F\u002Ft.me\u002Fpanyukovnikolay\" rel=\"noopener noreferrer nofollow\"\u003Eмой блог в телеграм\u003C\u002Fa\u003E, где я раньше всего публикую материалы по java разработке и личной эффективности.\u003C\u002Fp\u003E\u003Chr\u002F\u003E\u003Ch3\u003EОглавление\u003C\u002Fh3\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EПроблема двойной записи\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EМодульный монолит\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EДвухфазный коммит\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EОркестрация SAGA\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EХореография SAGA\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EХореография с двойной записью\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EХореография без двойной записи\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EХореография с Debezium\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EХореография с event sourcing\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EParallel pipelines\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Col\u003E\u003Cli\u003E\u003Cp\u003EListen to yourself\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003EОбщие выводы по всем паттернам\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Fol\u003E\u003Chr\u002F\u003E\u003Cp\u003EВ статье рассматриваются общие подходы к решению проблемы двойной записи, когда два микросервиса должны гарантировано, атомарно записать информацию в бд.\u003C\u002Fp\u003E\u003Cp\u003EКаждый из рассмотренных вариантов имеет свои достоинства и недостатки, и может быть применен в промышленной разработке.\u003C\u002Fp\u003E\u003Ch2\u003EПроблема двойной записи\u003C\u002Fh2\u003E\u003Cp\u003Edual write problem\u003C\u002Fp\u003E\u003Cp\u003EГлавным индикатором проблемы двойной записи является необходимость атомарной записи в нескольких микросервисах.\u003C\u002Fp\u003E\u003Cp\u003EНапример:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eваш сервис должен обновить свою бд и также уведомить другой сервис об изменениях\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eимеются транзакции, выполняемые в нескольких сервисах\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EВ нашем примере клиент вызывает микросервис А, который должен обновить бд, и данный сервис вызывает микросервис Б, который также должен выполнить операцию записи в свою бд.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F28f\u002Feab\u002F4e1\u002F28feab4e11d628c8e2f0149bf4282137.png\" width=\"1380\" height=\"1110\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F28f\u002Feab\u002F4e1\u002F28feab4e11d628c8e2f0149bf4282137.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F28f\u002Feab\u002F4e1\u002F28feab4e11d628c8e2f0149bf4282137.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EЗдесь есть критичный момент, если уведомление об обновлении бд будет отправлено сервисом А после записи в бд А, то существует вероятность, что отправка прервется, из-за чего сервис Б останется в неконсистентном состоянии.\u003C\u002Fp\u003E\u003Cp\u003EЕсли же сообщение будет отправлено перед записью в бд А, то есть вероятность, что запись в бд А прервется с ошибкой и сервис А останется неконсистентным.\u003C\u002Fp\u003E\u003Cp\u003EДалее будут рассмотрены варианты решения данной проблемы\u003C\u002Fp\u003E\u003Ch2\u003EМодульный монолит\u003C\u002Fh2\u003E\u003Cp\u003EModular monolith\u003C\u002Fp\u003E\u003Cp\u003EДанный подход не является паттерном микросервисов, но на практике он работает хорошо, и может быть использован в микросервисной архитектуре в качестве комбинированного решения (какие-то сервисы будут представлять из себя монолитное решение, какие-то останутся микросервисами).\u003C\u002Fp\u003E\u003Cp\u003EПодойдет, когда строгая связь между сервисами важнее, чем масштабируемость.\u003C\u002Fp\u003E\u003Ch2\u003EАрхитектура модульного монолита\u003C\u002Fh2\u003E\u003Cp\u003EНаличие модульного монолита не означает что архитектура приложения плохая.\u003C\u002Fp\u003E\u003Cp\u003EВ данном подходе каждый из микросервисов А и Б является отдельной библиотекой, которые устанавливаются в общее пространство и имеют доступ к одной и той же бд.\u003C\u002Fp\u003E\u003Cp\u003EПоскольку они находятся в одном пространстве и используют одну бд, они могут выполнять обработку в рамках одной и той же транзакции.\u003C\u002Fp\u003E\u003Cp\u003EТем не менее существует возможность полностью разделить два этих сервиса, даже в рамках одного монолита. Они могут смотреть на разные схемы, быть в разных пакетах, поддерживаться разными командами.\u003C\u002Fp\u003E\u003Cp\u003EИллюстрация разных уровней изоляции в монолитных и микросервисных архитектурах:\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F988\u002F822\u002Fe36\u002F988822e36c51909e438cf6dac29fc1bd.png\" width=\"1856\" height=\"1022\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F988\u002F822\u002Fe36\u002F988822e36c51909e438cf6dac29fc1bd.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F988\u002F822\u002Fe36\u002F988822e36c51909e438cf6dac29fc1bd.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EПоследней частью данного подхода является сервис-обертка (например класс, который будет оборачивать вызовы модулей в транзакцию), который может использовать оба наших сервиса А и Б и включать их в контекст существующей транзакции.\u003C\u002Fp\u003E\u003Cp\u003EЭто увеличивает связность сервисов, но сервис-обертка позволяет запустить транзакцию, вызвать наши сервисы, обновить их бд, закоммитить или откатить транзакцию в рамках одной операции, сохраняя все в консистентном состоянии.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F77f\u002F017\u002F35c\u002F77f01735c2f721af38d359d26c4678d6.png\" width=\"1484\" height=\"1574\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F77f\u002F017\u002F35c\u002F77f01735c2f721af38d359d26c4678d6.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F77f\u002F017\u002F35c\u002F77f01735c2f721af38d359d26c4678d6.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Ch3\u003EПлюсы Модульного монолита:\u003C\u002Fh3\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eпростая семантика транзакций, позволяющая легко обеспечивать консистентность данных\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch3\u003EМинусы Модульного монолита:\u003C\u002Fh3\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eединый рантайм сервисов А и Б не позволяет нам независимо деплоить и масштабировать модули, а также обеспечивать отказоустойчивость\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eлогическое разделение таблиц в рамках одной бд не является надежным, его могут захотеть изменить\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eтранзакция увеличивает связность между сервисами\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EРаспределенных транзакций желательно избегать, однако они являются необходимыми в следующих случаях:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eкогда записи в разные бд не могут быть согласованными\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eкогда нам приходится писать в разнородные источники данных (например в две разные бд)\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eкогда требуется однократная обработка сообщения и мы не можем сделать операции идемпотентными\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eпри интеграции со сторонними black-box системами (такие системы мы не можем изменить) или устаревшими системами, которые реализуют спецификацию двухфазного коммита\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch2\u003EДвухфазный коммит\u003C\u002Fh2\u003E\u003Cp\u003E2 Phase Commit - 2PC\u003C\u002Fp\u003E\u003Cp\u003EТехнические требования для имплементации 2PC:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eналичие менеджера транзакций, например Narayana\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eнадежное хранилище транзакционных логов\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eвсе бд, к которым подключены микросервисы должны иметь совместимость со стандартном DTP XA (distributed transaction processing) (XA - extended architecture), а также mq и кеши должны поддерживать XA драйвер\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eесли у вас есть все необходимое, но при этом приложение деплоится в динамическое окружение, такое как Kubernetes, вам понадобиться некий управляющий механизм, который будет гарантировать, что есть только один экземпляр менеджера распределенных транзакций. Транзакционный менеджер должен быть всегда доступен и для него всегда должен быть обеспечен доступ к транзакционным логам. Пример Snowdrop Recovery Controller\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Cp\u003EПример работы 2PC в статье описан очень плохо, поэтому описание алгоритма 2PC взято из другого источника.\u003C\u002Fp\u003E\u003Cp\u003EКод приложения в первую очередь обращается к координатору, получает номер транзакции.\u003C\u002Fp\u003E\u003Cp\u003EС этим номером обращается к остальным системам, например к нескольким разным микросервисам, просит их внести изменения с указанным идентификатором транзакции\u003C\u002Fp\u003E\u003Cp\u003EЗатем приложение обращается к координатору с просьбой закоммитить транзакцию, после чего координатор сначала отправляет всем сигнал prepare, если все сервисы ответили успехом (они захватили write locks на своих бд), то им посылается сигнал commit.\u003Cbr\u002F\u003E\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F968\u002F68a\u002Fe1c\u002F96868ae1c7f934c83f0888c6270697bc.png\" width=\"1500\" height=\"868\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F968\u002F68a\u002Fe1c\u002F96868ae1c7f934c83f0888c6270697bc.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F968\u002F68a\u002Fe1c\u002F96868ae1c7f934c83f0888c6270697bc.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EТеперь транзакция завершена.\u003C\u002Fp\u003E\u003Cp\u003EПротокол двухфазного коммита появился в 70-х годах.\u003C\u002Fp\u003E\u003Cp\u003EДвухфазный коммит предлагает те же гарантии что и единая транзакция в монолите, разве что возможны ошибки в данных при падении транзакционного менеджера.\u003C\u002Fp\u003E\u003Ch3\u003EПлюсы 2PC\u003C\u002Fh3\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eявляется стандартным решением, существуют готовые менеджеры транзакций и множество бд его поддерживают\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eстрогая консистентность данных\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch3\u003EМинусы 2PC\u003C\u002Fh3\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eсложная конфигурация\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eнизкая производительность\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eограниченная масштабируемость (практически невозможно масштабировать)\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eвозможные отказы, при падении менеджера транзакций\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eне все системы имеют поддержку (например NoSQL не интегрируются, mq или кеши могут не поддерживать спецификацию)\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eособые требования в динамических окружениях, таких как Kubernetes\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch2\u003EОркестрация SAGA\u003C\u002Fh2\u003E\u003Cp\u003EOrchestration\u003C\u002Fp\u003E\u003Cp\u003EВ модульном монолите и 2PC мы гарантируем консистентность данных.\u003C\u002Fp\u003E\u003Cp\u003EНо что если мы хотим ослабить требования к консистентности, при этом сохранив управление из одного места. В таком случае нам подойдет оркестрация. Когда один из сервисов выступает в качестве Оркестратора для всего состояния в распределенной системе.\u003C\u002Fp\u003E\u003Cp\u003EОркестратор несет ответственность за вызов сервисов, до тех пор пока они не достигнуть требуемого состояния или выполнит корректирующие действия в случае возникновения ошибки. Оркестратор использует свою бд для хранения состояния изменений и он ответственен за восстановление при любом падении в процессе изменения состояния.\u003C\u002Fp\u003E\u003Ch3\u003EВнедрение архитектуры оркестрации\u003C\u002Fh3\u003E\u003Cp\u003EНаиболее популярная имплементация - BPMN спецификация, пример jBPM или Camunda.\u003C\u002Fp\u003E\u003Cp\u003EЕсть также новые решение, которые не основываются на BPMN спецификации, но предлагают похожий подход - Conductor от Netflix, Cadence от Uber, Airflow от Apache.\u003C\u002Fp\u003E\u003Cp\u003EТакже к этой категории относятся serverless statefull functions такие как Amazon StepFunctions, Azure Durable Functions, Azure Logic Apps.\u003C\u002Fp\u003E\u003Cp\u003EЕсть opensource библиотеки, которые позволяют внедрить данное поведение - Apache Camel's Saga, NServiceBus Saga.\u003C\u002Fp\u003E\u003Cp\u003EМножество доморощенных систем имплементируют паттерн Saga.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffa0\u002Ff47\u002F76d\u002Ffa0f4776d8379c602eacec367c31e7ff.png\" width=\"1888\" height=\"1072\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffa0\u002Ff47\u002F76d\u002Ffa0f4776d8379c602eacec367c31e7ff.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Ffa0\u002Ff47\u002F76d\u002Ffa0f4776d8379c602eacec367c31e7ff.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EУ нас есть сервис А, который выступает как оркестратор, он вызывает сервис Б и восстанавливается от падений с помощью компенсаторной операции при необходимости.\u003C\u002Fp\u003E\u003Cp\u003EКлючевым моментом является то, что оба сервиса работают в своих локальных транзакциях\u003Cbr\u002F\u003E В данном случае запрос от сервиса А к сервису Б будет выполнен в рамках транзакции.\u003C\u002Fp\u003E\u003Cp\u003EПример плохо прописан в статье, поэтому привожу более простое описание:\u003Cbr\u002F\u003E Есть один сервис-оркестратор, который запускает транзакции в остальных сервисах и если что-то пошло не так, то вызывает соответствующие компенсирующие транзакции в этих сервисах, при этом выполнение каждого из шагов обновляет текущий статус операции.\u003C\u002Fp\u003E\u003Cp\u003EОркестрация является подходом с консистентностью в конечном счете, которая может включать в себя реатраи и роллбеки, для поддержки консистентного состояния.\u003C\u002Fp\u003E\u003Cp\u003EСервисы участники данного паттерна должны предоставлять идемпотентные операции, поскольку возможно выполнение ретраев, также они должны предоставлять эндпоинты для отката транзакций, чтобы сохранять согласованность данных.\u003C\u002Fp\u003E\u003Cp\u003EСильной стороной данного подхода является возможность разных сервисов, не поддерживающих распределенных транзакций, оставаться в консистентном состоянии используя только локальные транзакции.\u003C\u002Fp\u003E\u003Cp\u003EПри этом всегда можно узнать текущее состояние системы у координатора.\u003C\u002Fp\u003E\u003Ch3\u003EПлюсы Оркестрации:\u003C\u002Fh3\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eуправление состоянием между разными сервисами в распределенной системе\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eнет необходимости в XA транзакциях\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eвсегда можно узнать в каком состоянии находится система\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch3\u003EМинусы Оркестрации:\u003C\u002Fh3\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eсложная распределенная модель разработки\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eтребует наличия идемпотентности и компенсаторных транзакций\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eсогласованность в конечном счете\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eвозможны невосстанавливаемые падения (unrecoverable failures) при выполнении компенсаторных транзакций\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch2\u003EХореография SAGA\u003C\u002Fh2\u003E\u003Cp\u003EChoreography\u003C\u002Fp\u003E\u003Cp\u003EАльтернативным решением для Оркестрации является Хореография - где нет оркестратора, управляющего всем процессом.\u003C\u002Fp\u003E\u003Cp\u003EВ данном паттерне каждый из сервисов выполняет локальную транзакцию и публикует события, которые вызывают локальные транзакции в остальных сервисах.\u003C\u002Fp\u003E\u003Cp\u003EКаждый компонент системы участвует в принятии решения о судьбе транзакции. \u003C\u002Fp\u003E\u003Cp\u003EИсторически сложилось, что самой популярной имплементацией хореографии является подход использующий асинхронный обмен сообщениями для взаимодействия между сервисами.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F719\u002F821\u002F0af\u002F7198210af008b064fe2065c1acfa581c.png\" width=\"1862\" height=\"968\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F719\u002F821\u002F0af\u002F7198210af008b064fe2065c1acfa581c.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F719\u002F821\u002F0af\u002F7198210af008b064fe2065c1acfa581c.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Ch3\u003EХореография с двойной записью\u003C\u002Fh3\u003E\u003Cp\u003EПри использовании данного паттерна мы сталкиваемся с проблемой двойной записи, когда нам необходимо выполнить локальную транзакцию и отправить сообщение в очередь.\u003C\u002Fp\u003E\u003Cp\u003EЗдесь присутствуют те же недостатки:\u003C\u002Fp\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eотправить сообщение затем закоммитить - является непрактичным решением, поскольку локальная транзакция может откатиться, а сообщение уже будет отправлено\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eзакоммитить транзакцию и затем отправить сообщение - остается возможность падения приложения после коммита транзакции и перед отправкой сообщения. Однако данное решение лучше, поскольку можно задизайнить приложение таким образом, чтобы выполнялись ретраи\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch3\u003EХореография без двойной записи\u003C\u002Fh3\u003E\u003Cp\u003EОдним из возможных решений является запись в рамках одной транзакции в бд и никуда не отправлять сообщение.\u003C\u002Fp\u003E\u003Cp\u003EПример - Сервис А сохраняет запрос и пишет в бд А. Сервис Б периодически опрашивает Сервис А и находит изменения, при обнаружении изменений Сервис Б обновляет свою бд.\u003C\u002Fp\u003E\u003Cp\u003EВажнейшей частью данного подхода является то, что оба сервиса выполняют запись в свои бд в рамках локальных транзакций.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Feba\u002F193\u002F082\u002Feba193082c5b64fa5ca28a264e215a26.png\" width=\"1852\" height=\"1190\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Feba\u002F193\u002F082\u002Feba193082c5b64fa5ca28a264e215a26.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Feba\u002F193\u002F082\u002Feba193082c5b64fa5ca28a264e215a26.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВ данном подходе сервис Б смотрит напрямую в бд А.\u003Cbr\u002F\u003EЧто выстраивает жесткую связность между сервисами, поскольку изменения в структуре бд на стороне сервиса А влекут за собой изменения на стороне сервиса Б.\u003C\u002Fp\u003E\u003Cp\u003EМы можем улучшить данный подход, создав на стороне сервиса А отдельную таблицу, которую будет читать Б, что упрощает внесение изменений.\u003C\u002Fp\u003E\u003Cp\u003EЛибо пойти дальше и создать на стороне сервиса А API для подключению к бд А.\u003C\u002Fp\u003E\u003Cp\u003EОднако данный подход страдает от одного недостатка - необходимость постоянно запрашивать сервисом Б данные из сервиса А.\u003C\u002Fp\u003E\u003Ch3\u003EХореография с Debezium\u003C\u002Fh3\u003E\u003Cp\u003EОдин из вариантов сделать хореографию более удобной - использовать инструмент наподобие Debezium, который может отследить обновления в Сервисе А, захватывая изменение данных бд (CDC - change data capture), используя транзакционный лог базы данных А.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6ad\u002Fd69\u002F78b\u002F6add6978bc81b99eb4cd5ba02b3648c0.png\" width=\"1836\" height=\"862\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6ad\u002Fd69\u002F78b\u002F6add6978bc81b99eb4cd5ba02b3648c0.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F6ad\u002Fd69\u002F78b\u002F6add6978bc81b99eb4cd5ba02b3648c0.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EDebezium умеет отслеживать транзакционный лог в ожидании необходимых событий, после чего отправлять их в Apache Kafka.\u003C\u002Fp\u003E\u003Cp\u003EСервис Б слушает топик в Kafka, вместо того, чтобы опрашивать сервис А.\u003C\u002Fp\u003E\u003Cp\u003EТакой подход более надежный и масштабируемый.\u003C\u002Fp\u003E\u003Cp\u003EВозможный сайд эффект - сервис Б может получить одно и то же сообщение дважды, это может быть исправлено, если сделать сервис Б идемпотентным, или использовать подход дедубликации (Apache Active MQ duplicate message detection, Apache Camel's idempotent consumer pattern).\u003C\u002Fp\u003E\u003Cp\u003EДанный вариант является примером паттерна Transactional Outbox, однако про него стоит почитать отдельно в \u003Ca href=\"https:\u002F\u002Fmicroservices.io\u002Fpatterns\u002Fdata\u002Ftransactional-outbox.html\" rel=\"noopener noreferrer nofollow\"\u003Eданной статье\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Ch3\u003EХореография с Event sourcing\u003C\u002Fh3\u003E\u003Cp\u003EПри данном подходе состояние сущности хранится как последовательность событий, меняющих это состояние.\u003C\u002Fp\u003E\u003Cp\u003EАтомарное добавление записи об обновлении состояния записывается в бд с помощью локальной транзакции.\u003C\u002Fp\u003E\u003Cp\u003EПри этом хранилище событий также выступает как mq для других сервисов.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F55c\u002F2d5\u002Fe1c\u002F55c2d5e1c2c98c9ab5f56aaab8edc568.png\" width=\"1872\" height=\"1158\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F55c\u002F2d5\u002Fe1c\u002F55c2d5e1c2c98c9ab5f56aaab8edc568.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F55c\u002F2d5\u002Fe1c\u002F55c2d5e1c2c98c9ab5f56aaab8edc568.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cp\u003EВ приведенном примере запросы клиента будут храниться в append-only хранилище событий.\u003C\u002Fp\u003E\u003Cp\u003EТакже хранилище событий должно позволять Сервису Б быть подписанным на него.\u003C\u002Fp\u003E\u003Cp\u003EТем самым Сервис А использует свое хранилище для коммуникации с другими сервисами.\u003C\u002Fp\u003E\u003Cp\u003EEvent sourcing является непривычным подходом к программированию и добавляет сложность для воспроизведения состояния сущности.\u003C\u002Fp\u003E\u003Cp\u003EПро него также стоит почитать подробнее \u003Ca href=\"https:\u002F\u002Fmicroservices.io\u002Fpatterns\u002Fdata\u002Fevent-sourcing.html\" rel=\"noopener noreferrer nofollow\"\u003Eв данной статье\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Ch3\u003EПлюсы Хореографии\u003C\u002Fh3\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eубирает связность между реализацией и взаимодействием\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eнет единого координатора\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eулучшенная масштабируемость и устойчивость\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eпроще при использовании соответствующих инструментов, таких как Debezium\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch3\u003EМинусы Хореографии\u003C\u002Fh3\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eглобальное состояние системы распределено по сервисам-участникам (сложно узнать текущее состояние)\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003Cli\u003E\u003Cp\u003Eсогласованность в конечном счете\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch2\u003EParallel pipelines\u003C\u002Fh2\u003E\u003Cp\u003EПредыдущие паттерны предлагают нам последовательную обработку входящего запроса, однако возможна ситуация когда один и тот же запрос должен обрабатываться разными сервисами параллельно.\u003C\u002Fp\u003E\u003Cp\u003EДанный паттерн подразумевает возможность параллельно обрабатывать запросы, когда между сервисом А и сервисом Б нет прямой зависимости.\u003C\u002Fp\u003E\u003Cp\u003EДобавляется сервис router, который будет посылать сообщения в оба сервиса в рамках одной транзакции.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa00\u002Fbcb\u002F275\u002Fa00bcb27585441d07e1f5af03c29ee9a.png\" width=\"1850\" height=\"1798\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa00\u002Fbcb\u002F275\u002Fa00bcb27585441d07e1f5af03c29ee9a.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fa00\u002Fbcb\u002F275\u002Fa00bcb27585441d07e1f5af03c29ee9a.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Ch3\u003EListen to yourself\u003C\u002Fh3\u003E\u003Cp\u003EЕще одним вариантом parellel pipelines является ситуация, когда один из сервисов сам выступает роутером.\u003C\u002Fp\u003E\u003Cp\u003EТогда сервис А при получении сообщения кладет его в брокер сообщений, откуда оно будет считано как сервисом А, так и сервисом Б.\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F629\u002F77f\u002Fb49\u002F62977fb49331af4b7a8ab5098b7db197.png\" width=\"1816\" height=\"1016\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F629\u002F77f\u002Fb49\u002F62977fb49331af4b7a8ab5098b7db197.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F629\u002F77f\u002Fb49\u002F62977fb49331af4b7a8ab5098b7db197.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Ch3\u003EПлюсы Parallel Pipelines:\u003C\u002Fh3\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eпростая, масштабируемая архитектура для параллельной обработки\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch3\u003EМинусы Parallel Pipelines:\u003C\u002Fh3\u003E\u003Cul\u003E\u003Cli\u003E\u003Cp\u003Eсложно понять в каком состоянии находится системам в конкретный момент времени\u003C\u002Fp\u003E\u003C\u002Fli\u003E\u003C\u002Ful\u003E\u003Ch2\u003EОбщие выводы по всем паттернам\u003C\u002Fh2\u003E\u003Cp\u003EНет единого подхода для решения проблемы распределенных транзакций. \u003C\u002Fp\u003E\u003Cp\u003EКаждый паттерн имеет свои достоинства и недостатки, решая свою конкретную проблему.\u003C\u002Fp\u003E\u003Cp\u003EТаблица с характеристикой каждого подхода:\u003C\u002Fp\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F0d6\u002Fa02\u002Fd41\u002F0d6a02d41d342797249ff4d3e946fda9.png\" width=\"1826\" height=\"916\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F0d6\u002Fa02\u002Fd41\u002F0d6a02d41d342797249ff4d3e946fda9.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F0d6\u002Fa02\u002Fd41\u002F0d6a02d41d342797249ff4d3e946fda9.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Cfigure class=\"full-width \"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb50\u002F09d\u002Fa84\u002Fb5009da84dcb2fd8974f8a1324d16875.png\" width=\"1890\" height=\"1036\" sizes=\"(max-width: 780px) 100vw, 50vw\" srcset=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb50\u002F09d\u002Fa84\u002Fb5009da84dcb2fd8974f8a1324d16875.png 780w,&#10;       https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fgetpro\u002Fhabr\u002Fupload_files\u002Fb50\u002F09d\u002Fa84\u002Fb5009da84dcb2fd8974f8a1324d16875.png 781w\" loading=\"lazy\" decode=\"async\"\u002F\u003E\u003C\u002Ffigure\u003E\u003Ch3\u003EВысокая масштабируемость: Parallel pipelines и Хореография\u003C\u002Fh3\u003E\u003Cp\u003EЕсли сервисы не связаны между собой, то стоит использовать паттерн Parallel pipelines.\u003C\u002Fp\u003E\u003Cp\u003EЕсли вам нужна обработка по порядку, то стоит использовать паттерн Хореография.\u003C\u002Fp\u003E\u003Ch3\u003EСредняя масштабируемость: Оркестрация\u003C\u002Fh3\u003E\u003Cp\u003EЕсли хореография не подходит и вам нужен центральный сервис, ответственный за координацию, то вам подойдет оркестрация.\u003C\u002Fp\u003E\u003Ch3\u003EНизкая масштабируемость: Модульный монолит и 2PC\u003C\u002Fh3\u003E\u003Cp\u003EЕсли вам нужна строгая консистентность данных, то вам подойдет 2PC, но он имеет свои требования к софту, а также его сложно имплементировать на современных отказоустойчивых кластерах.\u003C\u002Fp\u003E\u003Cp\u003EПоэтому лучше использовать модульный монолит.\u003C\u002Fp\u003E\u003Cp\u003EВ большой распределенной системе скорее всего будет применен не один, а сразу несколько из описанных подходов, которые стоит применять по необходимости.\u003C\u002Fp\u003E\u003Cp\u003E\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"java"},{"titleHtml":"распределенные системы"},{"titleHtml":"микросервисы"},{"titleHtml":"saga"},{"titleHtml":"паттерны"},{"titleHtml":"2pc"},{"titleHtml":"оркестрация"},{"titleHtml":"хореография"},{"titleHtml":"архитектура"},{"titleHtml":"распределенные транзакции"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F28f\u002Feab\u002F4e1\u002F28feab4e11d628c8e2f0149bf4282137.png","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fupload_files\u002F28f\u002Feab\u002F4e1\u002F28feab4e11d628c8e2f0149bf4282137.png","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Farticles\\\u002F769102\\\u002F\"},\"headline\":\"Распределённые транзакции\",\"datePublished\":\"2023-10-22T14:31:04+03:00\",\"dateModified\":\"2024-02-15T10:45:14+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"panyukovnikolay\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"На собеседованиях на позицию middle\\\u002Fsenior разработчика часто задают вопросы по распределенным транзакциям в микросервисной архитектуре.Мой коллега однажды посов...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Farticles\\\u002F769102\\\u002F#post-content-body\",\"about\":[\"h_java\",\"h_distributed_systems\",\"h_microservices\",\"f_develop\",\"f_admin\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F769102\\\u002F3dd3d08f143000a551bb01db6c515e39\\\u002F\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F28f\\\u002Feab\\\u002F4e1\\\u002F28feab4e11d628c8e2f0149bf4282137.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F988\\\u002F822\\\u002Fe36\\\u002F988822e36c51909e438cf6dac29fc1bd.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F77f\\\u002F017\\\u002F35c\\\u002F77f01735c2f721af38d359d26c4678d6.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F968\\\u002F68a\\\u002Fe1c\\\u002F96868ae1c7f934c83f0888c6270697bc.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Ffa0\\\u002Ff47\\\u002F76d\\\u002Ffa0f4776d8379c602eacec367c31e7ff.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F719\\\u002F821\\\u002F0af\\\u002F7198210af008b064fe2065c1acfa581c.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Feba\\\u002F193\\\u002F082\\\u002Feba193082c5b64fa5ca28a264e215a26.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F6ad\\\u002Fd69\\\u002F78b\\\u002F6add6978bc81b99eb4cd5ba02b3648c0.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F55c\\\u002F2d5\\\u002Fe1c\\\u002F55c2d5e1c2c98c9ab5f56aaab8edc568.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fa00\\\u002Fbcb\\\u002F275\\\u002Fa00bcb27585441d07e1f5af03c29ee9a.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F629\\\u002F77f\\\u002Fb49\\\u002F62977fb49331af4b7a8ab5098b7db197.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002F0d6\\\u002Fa02\\\u002Fd41\\\u002F0d6a02d41d342797249ff4d3e946fda9.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fupload_files\\\u002Fb50\\\u002F09d\\\u002Fa84\\\u002Fb5009da84dcb2fd8974f8a1324d16875.png\"]}","metaDescription":"На собеседованиях на позицию middle\u002Fsenior разработчика часто задают вопросы по распределенным транзакциям в микросервисной архитектуре. Мой коллега однажды посоветовал отличную статью со сравнением...","mainImageUrl":null,"amp":true,"customTrackerLinks":[]},"polls":[],"commentsEnabled":{"status":true,"reason":null},"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"hasPinnedComments":false,"format":null,"banner":null,"multiwidget":null,"multiwidgetUuid":null,"readingTime":10,"complexity":"medium","isEditorial":false,"authorEmail":"panyukovnn@gmail.com","regionalRestrictions":[]}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"postReasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":["418117","902240","346198","738022","559640","570674","811479","894676","760434","776342"],"viewedPosts":[],"myFeedFilter":{"complexity":"all","score":"all","types":["articles","posts","news"]},"myFeedIsApplyFilters":false,"myFeedIsForce":false,"karma":{"userReasonsList":null}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[{"title":"Blockchain разработчик","vacanciesCount":0,"itemUrl":"https:\u002F\u002Fcareer.habr.com\u002Fvacancies\u002Fblockchain_developer","itemHubs":["distributed_systems","cryptocurrency","solidity"]},{"title":"Java разработчик","vacanciesCount":197,"itemUrl":"https:\u002F\u002Fcareer.habr.com\u002Fvacancies\u002Fjava_developer","itemHubs":["java","javame_dev","gradle"]}],"hubs":"java,distributed_systems,microservices"},"comments":{"articleComments":{},"articlePinnedComments":{},"searchCommentsResults":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":"","idempotenceKey":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"multiwidgets":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"multiwidgetLoading":false,"vacancies":{},"companiesGalleries":{},"companiesBanners":{},"companiesLandingVacancies":{},"companiesTechnologies":{},"workplaceInfo":null},"companyAdmin":{"companyInfo":null,"companyInfoLoading":false,"faqArticles":null,"brandingPreviewImageUrl":null,"jivoStatus":0,"adminNotifications":null,"availableInvitesCount":{}},"companyAdd":{"currentStep":"","stepsData":{},"uncompletedSteps":[],"isStepLoading":true,"isStepCommitting":false,"isInitialized":false,"agreementContent":""},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"pagesCount":0},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":true},"fixedBanner":{"isArticleStickyPanelVisible":false,"isArticleStickyPanelAtTheBottom":false,"isFixedBannerVisible":false,"isStickyPanelIconsHidden":false},"flows":{"updates":{}},"global":{"isPwa":false,"device":"desktop","isHabrCom":true,"requestId":"7142d5da3f7d4deb60db2148eca6eb50"},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"welcomePage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"query":{},"pathname":"\u002Fru\u002Farticles\u002F769102\u002F","path":"\u002Fru\u002Farticles\u002F769102\u002F","href":"\u002Fru\u002Farticles\u002F769102\u002F"}},"me":{"user":{"id":"3835876","alias":"panyukovnikolay","fullname":null,"avatarUrl":null,"groups":["normal"],"settings":{"miscSettings":{"viewCommentsRefresh":true,"enableShortcuts":true,"hideAdv":false,"enableReadingHistory":false,"digestSubscription":null,"useMarkdown":false,"useMarkdownInComments":false,"useMarkdownInArticles":false,"useMarkdownInPosts":false},"langSettings":{"hl":"ru","fl":"ru"},"chargeSettings":{"postVoteCount":14,"commentVoteCount":28},"permissionSettings":{"canAddComplaints":false,"canCreateVoices":false}},"crc32":"1647681239","gaUid":"3de7edb443d4d4eaf06d4a27c8575170","availableInvitesCount":0,"email":"panyukovnn@gmail.com","scoreStats":{"score":14,"votesCount":18},"ppaBalance":null,"notices":[],"rssKey":"10eeb18613adbe9d8f5f0ec3735a6d15","companiesAdmin":[],"ppg":null,"block":null,"onboarding":{"status":"complete","reason":"another","registration":{"status":"complete","reason":"another"},"reactions":{"status":"complete"}},"notificationUnreadCounters":{"total":0}},"uuid":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null,"userUpdates":{"feeds":{"newPostsCount":0,"newThreadsCount":0,"newNewsCount":0,"newCount":0},"conversationUnreadCount":0},"features":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"onboarding":{"currentStep":null,"stepsData":{},"stepsErrors":{},"completedSteps":[],"isStepCommitting":false,"isCommitDisabled":true},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{"questions":"project-block-article"}},"promoData":{"isLoading":false,"hasLoaded":false,"featurer":null,"megaposts":null,"promoLinks":null,"promoPosts":null,"sticker":null},"publicationStatistics":{"statsInfo":{},"statsFunnels":{},"statsGraph":{},"defaultSuggest":{},"suggest":{},"timeTracker":{},"isTrackingActivity":false,"isUserActive":true,"otherPublicationStats":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"search":{"searchQueryError":null},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":true,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"stories":{"stories":null},"technotext":{"years":[],"technotextDocForNominees":null,"technotextDocForWinners":null,"technotextInfo":{},"technotextInfoLoading":false,"technotextWinners":{},"technotextWinnersLoading":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"userVotes":{"karmaVotesList":[],"karmaVotesPagesCount":null,"karmaVotesListLoading":false,"commentsVotesList":[],"commentsVotesPagesCount":null,"commentsVotesListLoading":false,"postsVotesList":[],"postsVotesPagesCount":null,"postsVotesListLoading":false,"userVotesList":[],"userVotesPagesCount":null,"userVotesListLoading":false},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"userSpecialization":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"notificationsLoading":false,"notificationsList":[],"notificationsPageCount":0,"pendingMarkNotificationsRead":[],"publicationsLoading":true,"publicationsList":[],"publicationsPageCount":0,"pendingDeletePublications":false,"pendingMarkPublicationsRead":false},"events":{"eventRefs":{},"eventIds":[],"pagesCount":0,"categories":[],"cities":[],"actualEvents":null,"currentEvent":null,"eventsFilter":{"city":"all","timeStarted":null,"timeEnded":null}},"wysiwyg":{"WYSIWYGRulesRefs":null},"refs":{"specializationRefs":[]},"hint":{"hints":{}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="https://assets.habr.com/habr-web/js/chunk-vendors.978df117.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.58b8c457.js" defer></script></div>
<div id="overlays"><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--><!----><!--teleport anchor--></div>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-S28W1WC23F"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
</script>

<script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

</script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        setTimeout(() => {
            const img = new Image();
            img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
    });
</script>

</body>

</html>
